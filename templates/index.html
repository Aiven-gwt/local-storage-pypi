<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Package Repo</title>
<!--    <script src="https://cdn.tailwindcss.com"></script>-->
    <script src="{{ url_for('static', path='css/tailwind.min.css') }}"></script>
<!--    <link href="{{ url_for('static', path='css/tailwind.min.css') }}" rel="stylesheet">-->
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Python Package Repository</h1>

        <!-- Форма авторизации -->
        <div id="login-form" class="mb-4">
            <h2 class="text-xl font-bold mb-2">Login</h2>
            <input type="text" id="username" placeholder="Username" class="border p-2 mb-2 w-full">
            <input type="password" id="password" placeholder="Password" class="border p-2 mb-2 w-full">
            <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded">Login</button>
            <p id="login-status" class="text-sm text-gray-600"></p>
        </div>

        <!-- Форма загрузки (видна только админам) -->
        <div id="upload-section" style="display: none;">
            <h2 class="text-xl font-bold mb-2">Upload Package</h2>
            <input type="file" id="packageFile">
            <button onclick="uploadPackage()" class="bg-blue-500 text-white px-4 py-2 rounded">Upload</button>
            <p id="uploadStatus" class="text-sm text-gray-600"></p>
        </div>

        <!-- Поиск -->
        <div class="flex mb-4">
            <input type="text" id="search" placeholder="Search packages..." class="border p-2 w-full">
            <button onclick="performSearch()" class="bg-blue-500 text-white px-4 py-2 ml-2 rounded">Search</button>
        </div>

        <!-- Список пакетов -->
        <div id="package-list" class="border p-4 bg-white rounded shadow">
            <!-- Список пакетов будет загружен сюда -->
        </div>

        <!-- Добавим блок для отображения уведомлений -->
        <div id="notification" class="fixed bottom-4 right-4 hidden">
            <div class="bg-red-500 text-white px-4 py-2 rounded shadow-lg">
                <p id="notification-message"></p>
                <ul id="missing-deps-list" class="list-disc pl-5 mt-2"></ul>
            </div>
        </div>
    </div>

    <script>
        let authHeader = null;
        const serverIp = "{{ server_ip }}";
        const serverPort = "{{ server_port }}";
        const baseUrl = `http://${serverIp}:${serverPort}`;

        // Авторизация
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const status = document.getElementById('login-status');

            try {
                const response = await fetch('/user/login', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${btoa(`${username}:${password}`)}`,
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    status.textContent = `Logged in as ${data.username} (${data.role})`;
                    authHeader = `Basic ${btoa(`${username}:${password}`)}`; // Сохраняем заголовок авторизации
                    localStorage.setItem('authHeader', authHeader); // Сохраняем заголовок авторизации
                    localStorage.setItem('role', data.role); // Сохраняем роль пользователя
                    updateUI(data.role); // Обновляем интерфейс
                    loadPackageList(); // Загружаем список пакетов
                } else {
                    const data = await response.json();
                    status.textContent = `Error: ${data.detail}`;
                }
            } catch (error) {
                status.textContent = "Failed to login.";
            }
        }

        // Обновление интерфейса в зависимости от роли
        function updateUI(role) {
            const uploadSection = document.getElementById('upload-section');
            const deleteButtons = document.querySelectorAll('.delete-button');

            if (role === 'admin') {
                uploadSection.style.display = 'block'; // Показываем форму загрузки для админов
                deleteButtons.forEach(button => button.style.display = 'inline-block'); // Показываем кнопки удаления
            } else {
                uploadSection.style.display = 'none'; // Скрываем форму загрузки для пользователей
                deleteButtons.forEach(button => button.style.display = 'none'); // Скрываем кнопки удаления
            }
        }

        // Загрузка основного списка пакетов
        async function loadPackageList() {
            const packageList = document.getElementById('package-list');

            try {
                const response = await fetch('/packages/list');
                if (!response.ok) {
                    throw new Error("Failed to fetch packages");
                }
                const packages = await response.json();

                if (packages.length === 0) {
                    packageList.innerHTML = '<p class="text-gray-500">No packages found.</p>';
                } else {
                    packageList.innerHTML = packages.map(pkg => `
                        <div class="flex justify-between border-b p-2">
                            <a href="${baseUrl}/simple/${pkg}/" target="_blank">${pkg}</a>
                            <button class="delete-button bg-red-500 text-white px-2 py-1 rounded" onclick="deletePackage('${pkg}')">Delete</button>
                        </div>
                    `).join('');
                    updateUI(localStorage.getItem('role')); // Обновляем видимость кнопок удаления
                }
            } catch (error) {
                packageList.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }

        // Поиск пакетов
        document.getElementById('search').addEventListener('keypress', async function(event) {
            if (event.key === 'Enter') {
                let query = this.value.trim();
                let packageList = document.getElementById('package-list');

                if (query.length === 0) {
                    loadPackageList(); // Если запрос пустой, загружаем основной список
                    return;
                }

                try {
                    let response = await fetch(`/packages/search?package_name=${query}`);
                    if (!response.ok) {
                        throw new Error("Failed to fetch packages");
                    }
                    let packages = await response.json();

                    if (packages.length === 0) {
                        packageList.innerHTML = '<p class="text-red-500">Package not found</p>';
                    } else {
                        packageList.innerHTML = packages.map(pkg => `
                            <div class="flex justify-between border-b p-2">
                                <a href="${baseUrl}/simple/${pkg}/" target="_blank">${pkg}</a>
                                <button class="delete-button bg-red-500 text-white px-2 py-1 rounded" onclick="deletePackage('${pkg}')">Delete</button>
                            </div>
                        `).join('');
                        updateUI(localStorage.getItem('role')); // Обновляем видимость кнопок удаления
                    }
                } catch (error) {
                    packageList.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                }
            }
        });

        // Ручной запуск поиска
        async function performSearch() {
            const searchInput = document.getElementById('search');
            const event = new KeyboardEvent('keypress', { key: 'Enter' });
            searchInput.dispatchEvent(event);
        }

        // Загрузка пакетов
        function showNotification(message, missingDeps = []) {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            const missingDepsList = document.getElementById('missing-deps-list');

            notificationMessage.textContent = message;
            missingDepsList.innerHTML = missingDeps.map(dep => `<li>${dep}</li>`).join('');

            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 10000);
        }

        async function uploadPackage() {
            const fileInput = document.getElementById('packageFile');
            const status = document.getElementById('uploadStatus');

            if (fileInput.files.length === 0) {
                status.textContent = "Please select a file.";
                return;
            }

            if (!authHeader) {
                status.textContent = "You must be logged in to upload packages.";
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            try {
                const response = await fetch('/packages/upload', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': authHeader,
                    },
                });

                if (response.ok) {
                    status.textContent = "Package uploaded successfully!";
                    loadPackageList(); // Обновляем список пакетов после загрузки
                } else {
                    const data = await response.json();
                    if (data.missing_dependencies) {
                        showNotification(data.message, data.missing_dependencies);
                    } else {
                        status.textContent = `Error: ${data.detail}`;
                    }
                }
            } catch (error) {
                status.textContent = "Failed to upload package.";
            }
        }

        // Удаление пакетов
        async function deletePackage(packageName) {
            if (!authHeader) {
                alert("You must be logged in to delete packages.");
                return;
            }

            try {
                const packageNameWithoutVersion = packageName.replace(/-.*$/, '');

                const response = await fetch(`/packages/${packageNameWithoutVersion}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': authHeader,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadPackageList(); // Обновляем список пакетов после удаления
                } else {
                    const data = await response.json();
                    alert(`Error: ${data.detail}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Проверка авторизации при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            const savedAuthHeader = localStorage.getItem('authHeader');
            const savedRole = localStorage.getItem('role'); // Получаем роль из localStorage
            if (savedAuthHeader) {
                authHeader = savedAuthHeader;
                updateUI(savedRole); // Обновляем интерфейс в зависимости от роли
            }
            loadPackageList(); // Загружаем список пакетов
        });
    </script>
</body>
</html>